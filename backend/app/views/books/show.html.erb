<div class="max-w-3xl mx-auto bg-white rounded-lg shadow p-6">
  <div class="flex items-start justify-between">
    <div>
      <h1 class="text-3xl font-bold mb-2"><%= @book.title %></h1>
      <p class="text-sm text-gray-600">by <%= @book.author.presence || 'Unknown' %></p>

      <!-- Average Rating Display -->
      <div class="flex items-center gap-3 mt-2">
        <div class="flex items-center">
          <% 5.times do |i| %>
            <svg class="w-5 h-5 <%= i < @book.average_rating ? 'text-yellow-400' : 'text-gray-300' %>" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9.049 2.927c.3-.921 1.602-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
            </svg>
          <% end %>
        </div>
        <span class="text-sm text-gray-600"><%= @book.average_rating %> (<%= @book.ratings.count %> ratings)</span>
      </div>

      <% if @book.published_at.present? %>
        <p class="text-sm text-gray-500">Published: <%= @book.published_at.strftime('%B %e, %Y') %></p>
      <% end %>
    </div>
    <div class="space-x-2">
      <%= link_to 'Edit', edit_book_path(@book), class: 'inline-block bg-yellow-400 text-black px-3 py-1 rounded hover:bg-yellow-500' %>
      <%= link_to 'Delete', book_path(@book), method: :delete, data: { confirm: 'Are you sure?' }, class: 'inline-block bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600' %>
    </div>
  </div>

  <div class="mt-6 prose">
    <%= simple_format(@book.description) %>
  </div>

  <!-- User Rating Section -->
  <% if user_signed_in? %>
    <div class="mt-6 p-4 bg-gray-50 rounded-lg" data-controller="rating" data-rating-book-id-value="<%= @book.id %>" data-rating-current-value="<%= @book.user_rating(current_user)&.score || 0 %>">
      <label class="block text-sm font-medium text-gray-700 mb-2">Your Rating:</label>
      <div class="flex items-center gap-1">
        <% 5.times do |i| %>
          <button type="button" 
                  data-rating-target="star"
                  data-action="click->rating#rate mouseover->rating#hover mouseout->rating#unhover"
                  data-rating-value="<%= i + 1 %>"
                  class="focus:outline-none cursor-pointer">
            <svg class="w-8 h-8 transition-colors" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9.049 2.927c.3-.921 1.602-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
            </svg>
          </button>
        <% end %>
      </div>
      <p class="text-sm text-green-600 mt-2 hidden" data-rating-target="message">Rating saved!</p>
    </div>
  <% else %>
    <div class="mt-6 p-4 bg-gray-50 rounded-lg text-center">
      <p class="text-sm text-gray-600">
        <%= link_to "Sign in", new_user_session_path, class: "text-blue-600 hover:underline" %> to rate this book
      </p>
    </div>
  <% end %>

  <div class="mt-6">
    <%= link_to 'Back to list', books_path, class: 'text-sm text-blue-600 hover:underline' %>
  </div>
</div>
